# 内存管理

**写时复制**

> 当子进程共享父进程空间的时候，只要其中任何一个进程需要写入，则该页面就被复制一份

**fork快速创建进程**

> 进程用户空间的创建，主要依赖与父进程。在创建过程中，所作的工作仅仅是建立
>
> **mm_struct** 结构、**vm_area_struct**结构、页目录和页表，并没有真正的复制一个物理页面。
>
> <img src="D:\documents\1 - summary\学习笔记\linux内核学习笔记\内存管理\fork.png" alt="image-20191221162633076" style="zoom:50%;" />

**虚存映射**

> 当使用exec开始执行一个进程的时候，进程的可执行影像包括：代码段、数据段、堆和栈等都必须装入到进程用户地址空间。
>
> 如果进程用到了共享库，则共享库也必须要装入进程用户空间。
>
> 由此可以看出，linux并不将影像装入到物理内存空间，而是将可执行文件映射到进程的用户空间，这种方法就是虚存映射。
>
> <img src="D:\documents\1 - summary\学习笔记\linux内核学习笔记\内存管理\虚存映射.png" alt="image-20191221162633076" style="zoom: 33%;" />

**vma创建**

> 用户空间： 通过系统调用mmap() -> 系统调用 -> do_mmap()
>
> 内核空间：调用 do_mmap()     创建一个虚存区
>
> 虚存区(虚拟映射空间)：共享的、私有的、匿名的。
>
> **共享**的虚存区： 多个进程共享这一映射（映射关系），当一个进程对共享虚存区写的时候，其他进程可以感知到它的写，而且
>
> 还会修改磁盘上的文件。所以文件的共享，就可以采用这种方式。
>
> **私有**的虚存区：进程创建这种映射仅仅为了读而不是写，因此对虚存区的操作就不会修改磁盘上的文件。因此此方式比共享的方式效率高。
>
> **匿名**映射：映射与文件无关。

**虚存区关系**

> 当可执行文件映射到进程的用户空间时，产生一组**vm_area_struct**结构，来表述各个虚存区的起始地址和终止地址。	
>
> <img src="D:\documents\1 - summary\学习笔记\linux内核学习笔记\内存管理\虚存区映射关系.png" alt="image-20191221162633076" style="zoom: 50%;" />

**查看进程的虚存区**

> /proc/pid/maps     pid为进程号
>
> 

